<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Page Title</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!--link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" /-->
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Site Description Here" />
<link rel="stylesheet" href="bulma.min.css">
<link rel="stylesheet" href="quill.snow.css">
<!-- Include the JS libraries -->
<script src="quill.min.js"></script>
<script src="vue.min.js"></script>
<style>
@font-face {
  font-family: "archivo-regular";
  src: url("/Archivo-Regular.woff");
} 

body {
 font-family: archivo-regular;
}

.ctxmenu {
  cursor: context-menu;
  position: absolute;
}
.ctxmenu li {
  padding-left: 0.25em;
  padding-right: 0.25em;
}
.ctxmenu li:hover{
	background: #aaaaaa;
	color: #eeeeee;
}

.ico-edit {
  content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-edit-3'%3E%3Cpath d='M12 20h9'%3E%3C/path%3E%3Cpath d='M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z'%3E%3C/path%3E%3C/svg%3E");
  width: 1em;  
  height: 1em;
  margin-right: 1em;
}
.ico-del {
  content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-x-circle'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='15' y1='9' x2='9' y2='15'%3E%3C/line%3E%3Cline x1='9' y1='9' x2='15' y2='15'%3E%3C/line%3E%3C/svg%3E");
  width: 1em;  
  height: 1em;
  margin-right: 1em;
}
.ico-new {
  content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-file-plus'%3E%3Cpath d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'%3E%3C/path%3E%3Cpolyline points='14 2 14 8 20 8'%3E%3C/polyline%3E%3Cline x1='12' y1='18' x2='12' y2='12'%3E%3C/line%3E%3Cline x1='9' y1='15' x2='15' y2='15'%3E%3C/line%3E%3C/svg%3E");
  width: 1em;  
  height: 1em;
  margin-right: 1em;
}
.ico-left {
  content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-arrow-left-circle'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cpolyline points='12 8 8 12 12 16'%3E%3C/polyline%3E%3Cline x1='16' y1='12' x2='8' y2='12'%3E%3C/line%3E%3C/svg%3E");
  width: 1em;  
  height: 1em;
  margin-right: 1em;
}

.ico-load {
  content: url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjAiIHdpZHRoPSI2NHB4IiBoZWlnaHQ9IjY0cHgiIHZpZXdCb3g9IjAgMCAxMjggMTI4IiB4bWw6c3BhY2U9InByZXNlcnZlIj48Zz48cGF0aCBkPSJNNzEgMzkuMlYuNGE2My42IDYzLjYgMCAwIDEgMzMuOTYgMTQuNTdMNzcuNjggNDIuMjRhMjUuNTMgMjUuNTMgMCAwIDAtNi43LTMuMDN6IiBmaWxsPSIjMDAwIi8+PHBhdGggZD0iTTcxIDM5LjJWLjRhNjMuNiA2My42IDAgMCAxIDMzLjk2IDE0LjU3TDc3LjY4IDQyLjI0YTI1LjUzIDI1LjUzIDAgMCAwLTYuNy0zLjAzeiIgZmlsbD0iI2UxZTFlMSIgdHJhbnNmb3JtPSJyb3RhdGUoNDUgNjQgNjQpIi8+PHBhdGggZD0iTTcxIDM5LjJWLjRhNjMuNiA2My42IDAgMCAxIDMzLjk2IDE0LjU3TDc3LjY4IDQyLjI0YTI1LjUzIDI1LjUzIDAgMCAwLTYuNy0zLjAzeiIgZmlsbD0iI2UxZTFlMSIgdHJhbnNmb3JtPSJyb3RhdGUoOTAgNjQgNjQpIi8+PHBhdGggZD0iTTcxIDM5LjJWLjRhNjMuNiA2My42IDAgMCAxIDMzLjk2IDE0LjU3TDc3LjY4IDQyLjI0YTI1LjUzIDI1LjUzIDAgMCAwLTYuNy0zLjAzeiIgZmlsbD0iI2UxZTFlMSIgdHJhbnNmb3JtPSJyb3RhdGUoMTM1IDY0IDY0KSIvPjxwYXRoIGQ9Ik03MSAzOS4yVi40YTYzLjYgNjMuNiAwIDAgMSAzMy45NiAxNC41N0w3Ny42OCA0Mi4yNGEyNS41MyAyNS41MyAwIDAgMC02LjctMy4wM3oiIGZpbGw9IiNiZWJlYmUiIHRyYW5zZm9ybT0icm90YXRlKDE4MCA2NCA2NCkiLz48cGF0aCBkPSJNNzEgMzkuMlYuNGE2My42IDYzLjYgMCAwIDEgMzMuOTYgMTQuNTdMNzcuNjggNDIuMjRhMjUuNTMgMjUuNTMgMCAwIDAtNi43LTMuMDN6IiBmaWxsPSIjOTc5Nzk3IiB0cmFuc2Zvcm09InJvdGF0ZSgyMjUgNjQgNjQpIi8+PHBhdGggZD0iTTcxIDM5LjJWLjRhNjMuNiA2My42IDAgMCAxIDMzLjk2IDE0LjU3TDc3LjY4IDQyLjI0YTI1LjUzIDI1LjUzIDAgMCAwLTYuNy0zLjAzeiIgZmlsbD0iIzZlNmU2ZSIgdHJhbnNmb3JtPSJyb3RhdGUoMjcwIDY0IDY0KSIvPjxwYXRoIGQ9Ik03MSAzOS4yVi40YTYzLjYgNjMuNiAwIDAgMSAzMy45NiAxNC41N0w3Ny42OCA0Mi4yNGEyNS41MyAyNS41MyAwIDAgMC02LjctMy4wM3oiIGZpbGw9IiMzYzNjM2MiIHRyYW5zZm9ybT0icm90YXRlKDMxNSA2NCA2NCkiLz48YW5pbWF0ZVRyYW5zZm9ybSBhdHRyaWJ1dGVOYW1lPSJ0cmFuc2Zvcm0iIHR5cGU9InJvdGF0ZSIgdmFsdWVzPSIwIDY0IDY0OzQ1IDY0IDY0OzkwIDY0IDY0OzEzNSA2NCA2NDsxODAgNjQgNjQ7MjI1IDY0IDY0OzI3MCA2NCA2NDszMTUgNjQgNjQiIGNhbGNNb2RlPSJkaXNjcmV0ZSIgZHVyPSI3MjBtcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiPjwvYW5pbWF0ZVRyYW5zZm9ybT48L2c+PGc+PGNpcmNsZSBmaWxsPSIjMDAwIiBjeD0iNjMuNjYiIGN5PSI2My4xNiIgcj0iMTIiLz48YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJvcGFjaXR5IiBkdXI9IjcyMG1zIiBiZWdpbj0iMHMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBrZXlUaW1lcz0iMDswLjU7MSIgdmFsdWVzPSIxOzA7MSIvPjwvZz48L3N2Zz4=');
  width: 32px;  
  height: 32px;
}

.ico-logo {
  content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24' fill='none' stroke='grey' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-aperture'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='14.31' y1='8' x2='20.05' y2='17.94'%3E%3C/line%3E%3Cline x1='9.69' y1='8' x2='21.17' y2='8'%3E%3C/line%3E%3Cline x1='7.38' y1='12' x2='13.12' y2='2.06'%3E%3C/line%3E%3Cline x1='9.69' y1='16' x2='3.95' y2='6.06'%3E%3C/line%3E%3Cline x1='14.31' y1='16' x2='2.83' y2='16'%3E%3C/line%3E%3Cline x1='16.62' y1='12' x2='10.88' y2='21.94'%3E%3C/line%3E%3C/svg%3E");
  width: 32px;  
  height: 32px;
}

.ico-upload {
  content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-upload'%3E%3Cpath d='M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'%3E%3C/path%3E%3Cpolyline points='17 8 12 3 7 8'%3E%3C/polyline%3E%3Cline x1='12' y1='3' x2='12' y2='15'%3E%3C/line%3E%3C/svg%3E");
  width: 32px;  
  height: 32px;
}

.ico-file2 {
content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-file-text'%3E%3Cpath d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'%3E%3C/path%3E%3Cpolyline points='14 2 14 8 20 8'%3E%3C/polyline%3E%3Cline x1='16' y1='13' x2='8' y2='13'%3E%3C/line%3E%3Cline x1='16' y1='17' x2='8' y2='17'%3E%3C/line%3E%3Cpolyline points='10 9 9 9 8 9'%3E%3C/polyline%3E%3C/svg%3E");
  width: 96px;  
  height: 96px;
}

.brk {
  word-wrap: anywhere;
}
.mono {
font-family: monospace;
white-space: pre-wrap;
white-space: -moz-pre-wrap;
white-space: -pre-wrap;
white-space: -o-pre-wrap;
word-wrap: anywhere;
}
.ptr {
 cursor: pointer;
}
.spacer5px {
 height: 5px;
}
.sidenavbar {
 height: 75vh;
 overflow-y: scroll;

}
.tooloutput {
 height: 72vh;
 overflow-y: scroll;
}
.mpprojects {
 height: 68vh;
 overflow-y: scroll;
}
.fullw {
 width: 100%;
}
::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1; 
}
 
::-webkit-scrollbar-thumb {
  background: #888; 
}

::-webkit-scrollbar-thumb:hover {
  background: #555; 
}

</style>

    <!-- item template -->
    <script type="text/x-template" id="item-template">
      <li>
        <div
          :class="{bold: hasChildren}"
          @click="viewNode($event,item.uid)"
		  @contextmenu="showCtxMenu($event,item.uid)"
          >{{ item.l }}
          <span v-if="hasChildren" @click="toggle(item.uid)">[{{ isOpen ? '-' : '+' }}]</span>
        </div>
        <ul v-show="isOpen" v-if="hasChildren">
          <tree-item
            class="item"
            v-for="(child, index) in item.outrefs"
            :key="index"
            :item="child"
            @make-folder="$emit('make-folder', $event)"
            @add-item="$emit('add-item', $event)"
          ></tree-item>
        </ul>
      </li>
    </script>

</head>
<body><div id="body_container" onclick="HideContextMenu()">

<!-- Context Menu Template -->
<!-- ??? programatically generate the options using v-for, v-if?? 
yes, can @click="juju($event,a.v)  where a is in data for the ctxmenu-div vue binding
-->

 <div id="ctxmenu-div" class="ctxmenu box has-background-light p-2" style="display: none">
   <ul id="v_ctxmenu">
    <li><b>Actions</b></li>
	<li v-for="optM in vdata.ctxmenuData.mainOptions" @click="ctxmenuAction($event,optM,vdata.ctxmenuData.uid)"><img class="ico-edit">{{optM}}  testM</li>
	<li v-for="optA in vdata.ctxmenuData.addOptions" @click="ctxmenuAction($event,optA,vdata.ctxmenuData.uid)"><img class="ico-new">{{optA}}  testA</li>
   </ul>
</div>

<!--
<template id="ctxmenu-templ">
 <div id="ctxmenu-div" class="ctxmenu box has-background-light p-2" style="display: none">
   <ul>
	<li @click="ctxmenuAction($event,'edit')"><img class="ico-edit">Edit Subgroup</li>
	<li @click="ctxmenuAction($event,'del')"><img class="ico-del">Delete Subgroup</li>
	<li @click="ctxmenuAction($event,'add')"><img class="ico-new">New Item</li>
   </ul>
 </div>
</template>
-->
<!-- top nav bar -->
<nav class="level box p-1">

  <!-- Left side -->
  <div class="level-left ml-3">
    <div class="level-item mr-1">
	<img id="id_logo" class="ico-logo" onClick="">
    </div>
    <div class="level-item">
      <p class="subtitle is-3 ptr" onClick="">
        <strong>Miruket</strong>
      </p>
    </div>
    <div class="level-item">
      <div class="field has-addons">
        <p class="control">
          <input class="input is-small" type="text" placeholder="Query the Data" disabled>
        </p>
        <p class="control">
          <button class="button is-small" disabled>
            Search
          </button>
        </p>
      </div>
    </div>
  </div>

  <!-- Right side -->
  <div id="v_topnav" class="level-right">
    <!--p class="level-item"><strong>All</strong></p-->
    <p class="level-item"><strong>{{v.node.l}}</strong></p>
    <!--p class="level-item pr-4" v-if="pr.ref.t"><strong>&nbsp;>>&emsp;{{pr.ref.t}}</strong></p>
	<p class="level-item pr-4" v-else><strong>&nbsp;</strong></p-->

    <p class="level-item" onClick=""><a class="button is-small">Clients</a></p>
    <p class="level-item pr-4" onClick=""><a class="button is-small">Projects</a></p>
    <p class="level-item"><a @click="" class="button is-success is-small">Tasks</a></p>
  </div>

</nav>

<!-- columns view (tree + main panes) -->
<div id="columns_layout" class=""><!--orig class: columns ml-3-->

	
	  <div id="tree_pane" class="" style="width: 30vw; resize: horizontal"><!--orig class: column is-2-->
		  <ul id="v_tree_pane">
		<ctxmenu></ctxmenu>
			  <tree-item
				class="item"
				:item="treeData.root"
				@make-folder="makeFolder"
				@add-item="addItem"
				
			  ></tree-item>
			</ul>
		</div>
		<!--div id="v_tree_pane">
			<ctxmenu></ctxmenu>
			<p class="subtitle is-6 ptr" @contextmenu = "showCtxMenuGrpHdr($event)">Groups/Hosts</p>
			<div class="tile pr-3 is-vertical sidenavbar">
			  <div class="content" v-for="gr in pr.ref.out">
				<div class="has-text-primary-dark">
				  <div class="content is-medium brk mb-2 ptr" @contextmenu="showCtxMenuGrp($event,gr.uid)"><b>{{gr.t}}</b></div>
				</div>
				<div>
					<div class="tile" v-for="sg in gr.out">
					  <div class="content is-small ptr brk mb-2" @contextmenu="showCtxMenuSubgrp($event,sg.uid)" @click="vSelectSubGroup(sg.uid)">
					   <b>{{sg.t}}</b><br>[<span>{{sg.d}}</span><span></span>]
					  </div>
					</div>
				</div>
			  </div>
				<div v-if="!pr.ref.out || pr.ref.out.length < 1" class="tile">
				  <div class="content mb-2"><p><b>The current project does not contain any groups</b></p><p>Right-Click the header above to add one</p></div>
				</div>

			</div>
		</div>
	  </div><!--tree_pane-->

  <div id="main_pane" class=""><!--orig class: column-->

	<div id="view_projbackup" class="box content is-medium" style="display: none">
	<!--////VueBinding////-->
	<!--
		<div id="v_view_projbackup">
			<h2>Welcome to Miruket</h2>
			<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>{{main_pane_tooloutput.body}}
			<div class="pb-3"><a class="button is-success is-medium" @click="vNewClient()">New Client</a></div>
			<p>Select a Client to See Projects</p>
			<div v-for="(cl, index) in mpd_clientlist.list">
			<span class="ptr" @click="vSelectClient(cl.uid)">&raquo; {{cl.t}}</span><span class="pl-2 ptr" @click="vEditClient(cl.uid)"><img class="ico-edit"></span>
			</div>
		</div>
		-->
	</div>

	<div id="view_default" class="box content is-medium" style="display: none">
	<!--////VueBinding////-->
		<div id="v_view_default">
			<h2>Pane for {{v.config.title}}</h2>
			<div class="mpprojects">
				<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>{{v.config.nodeinfo.c}}
				<div class="pb-3"><a class="button is-success is-medium" @click="">New Project</a></div>
				<p>Select a Project from the List</p>
				<div v-for="(child, index) in v.config.nodeinfo.outrefs">
				<span class="ptr" @click="">{{child.uid}}&raquo; {{child.l}}</span><span class="pl-2 ptr" @click=""><img class="ico-edit"></span>
				</div>
			</div>
		</div>
	</div>
 
	<div id="view_textbody" class="box content is-small" style="display: none">
	<!--////VueBinding////-->
		<div id="v_view_textbody">
			<h2>[{{v.config.nodeinfo.d}}] {{v.config.nodeinfo.l}}</h2>
			<!--is-family-monospace test1 -->
			  <div class="tooloutput"><div class="mono">{{v.config.nodeinfo.x}}</div></div>
			
		</div>
	</div>

	<div id="view_editor" style="display: none">
		<!--div id="editable_buttonbar" class="mb-2">
			<a class="button is-primary" id="toggleEditing" onclick="setQuillState('toggle')">Edit</a>
			<div class="field">
			  <div class="control"><input class="input is-info" type="text" placeholder="Info input"></div>
			</div>
		</div-->

			  <div class="columns is-vcentered">				
				<div class="column is-10">
				  <div class="field">
					<p class="control">
					  <input id="editor_title" class="input titleedit" type="text" placeholder="Enter a Note Title">
					</p>
				  </div>
				</div>
				
				<div class="column is-2">
				  <a class="button is-primary" id="toggleEditing" onclick="toggleQuill()">Edit</a>
				</div>
				<!--div class="level-item">
				  <a class="button is-warning" id="canelEditing" onclick="">Cancel</a>
				</div-->
				
			  </div>
		
		<div id="editor" style="height: 65vh;"></div> 
    </div>
 
 	<div id="main_pane_testform" style="display: none">
	<!--////VueBinding////-->
	<!--
	 <div id="v_main_pane_testform">
		<h1 class="title">{{cl.action}} Details Form</h1>
		<div class="tooloutput">
		  <div class="pr-3">
			<div class="field">
			  <label class="label">Name</label>
			  <div class="control">
				<input class="input" type="text" placeholder="Client Short Name" v-model="cl.ref.t">
			  </div>
			</div>

			<div class="field">
			  <label class="label">Username</label>
			  <div class="control">
				<input class="input is-success" type="text" placeholder="Long Name or Description" v-model="cl.ref.d">
			  </div>
			  <p class="help is-success">This username is available</p>
			</div>

			<div class="field">
			  <label class="label">Subject</label>
			  <div class="control">
				<div class="select">
				  <select>
					<option>Select dropdown</option>
					<option>With options</option>
				  </select>
				</div>
			  </div>
			</div>

			<div class="field">
			  <label class="label">Message</label>
			  <div class="control">
				<textarea class="textarea" placeholder="Textarea"></textarea>
			  </div>
			</div>

			<div class="field">
			  <div class="control">
				<label class="checkbox">
				  <input type="checkbox">
				  I agree to the <a href="#">terms and conditions</a>
				</label>
			  </div>
			</div>

			<div class="field">
			  <div class="control">
				<label class="radio">
				  <input type="radio" name="question">
				  Yes
				</label>
				<label class="radio">
				  <input type="radio" name="question">
				  No
				</label>
			  </div>
			</div>

			<div class="field is-grouped">
			  <div class="control">
				<button class="button is-link" @click="vSubmit()">Submit</button>
			  </div>
			  <div class="control">
				<button class="button is-link is-light">Cancel</button>
			  </div>
			</div>
			
		  </div>
		</div>
	 </div>  
	 -->
    </div><!-- end main_pane -->
 
 
    <div id="edit_default" style="display: none">
	<!--////VueBinding////-->
	 <div id="v_edit_default">
		<h1 class="title">{{v.config.title}}</h1>
		<div class="tooloutput">
		  <div class="pr-3">
		  
			<div class="field">
			  <label class="label">Short Name</label><div class="control"><input class="input" type="text" placeholder="Client Short Name" v-model="v.config.nodeinfo.l"></div>
			</div>

			<div class="field">
			  <label class="label">Description</label><div class="control"><input class="input is-success" type="text" placeholder="Client Full Name or Description" v-model="v.config.nodeinfo.d"></div>
			</div>

			<div class="field">
			  <label class="label">Notes</label><div class="control"><textarea class="textarea" placeholder="Client notes area" v-model="v.config.nodeinfo.c"></textarea></div>
			</div>

			<div class="field is-grouped">
			  <div class="control"><button class="button is-link" @click="">Save</button></div>
			  <div class="control"><button class="button is-link is-light">Cancel</button></div>
			</div>
			
		  </div>
		</div>
	 </div>
    </div><!-- end main_pane -->



 
 	<div id="view_download" class="box content is-small" style="display: none">
	<!--////VueBinding////-->
		<div id="v_view_download">
			<h2>[{{v.config.nodeinfo.d}}] {{v.config.nodeinfo.l}}</h2>
			<div class="tooloutput">
				<div v-if="v.config.nodeinfo.c.startsWith('image/')">
				<img :src="'/download/'+v.config.nodeinfo.uid" id="imgview" class="ptr" onclick="toggleImgFullscreen()">
				</div>
				<div v-else>
				<h3>Download</h3>
				<p>
				<a :href="'/download/'+v.config.nodeinfo.uid">
				<img class="ico-file2"><br>
				{{v.config.nodeinfo.l}}</a>
				<br>({{v.config.nodeinfo.c}})
				</p>
				</div>
			</div>
		</div>
	</div>

 
 	<div id="view_image" class="box content is-small" style="display: none">
	<!--////VueBinding////-->
		<div id="v_view_image">
			<h2>[{{v.config.nodeinfo.d}}] {{v.config.nodeinfo.l}}</h2>
			<div class="tooloutput">
				<div v-if="v.config.nodeinfo.c.startsWith('image/')">
				<img :src="'/download/'+v.config.nodeinfo.uid" id="imgview" class="ptr" onclick="toggleImgFullscreen()">
				</div>
				<div v-else>
				<h3>Download</h3>
				<p>
				<a :href="'/download/'+v.config.nodeinfo.uid">
				<img class="ico-file2"><br>
				{{v.config.nodeinfo.l}}</a>
				<br>({{v.config.nodeinfo.c}})
				</p>
				</div>
			</div>
		</div>
	</div>


 
 
 
 
  </div><!--column-->
</div><!--columns_layout-->



<!--Modal Display-->
<div id="modal_div" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">



	<!--divs for modal panes-->
	<div id="add_fileupload" style="display: none">
	 <div id="v_add_fileupload"><!--bind Vue to this div-->
		<header class="modal-card-head">
		  <p id="modal_title" class="modal-card-title">Title</p>
		  <button class="delete" onclick="toggleModal()" aria-label="close"></button>
		</header>

		<section class="modal-card-body">
			<div class="file has-name">
			  <label class="file-label">
				<input class="file-input" type="file" id="at_file" name="upload">
				<span class="file-cta">
				  <span class="file-icon">
					<img class="ico-upload">
				  </span>
				  <span class="file-label">
					Choose a fileâ€¦
				  </span>
				</span>
				<span class="file-name" id="at_file_name">
				  No file selected
				</span>
			  </label>
			</div>
			<div class="field is-grouped">
				<div class="control">
					<button class="button is-link" onclick="">Submit</button>
				</div>
				<div class="control">
					<button class="button is-link is-light">Cancel</button>
				 </div>
			</div>
		</section>
		
		<footer class="modal-card-foot">
		  <button class="button is-success">Save changes</button>
		  <button class="button" onclick="toggleModal()">Cancel</button>
		</footer>
	 </div>
    </div><!--end modal pane-->




<!--divs for modal panes-->
	<div id="add_default" style="display: none">
	 <div id="v_add_default"><!--bind Vue to this div-->
		<header class="modal-card-head">
		  <p id="modal_title" class="modal-card-title">Title</p>
		  <button class="delete" onclick="toggleModal()" aria-label="close"></button>
		</header>

		<section class="modal-card-body">
	  		<h1 class="title">{{v.config.title}}</h1>
			<div class="tooloutput">
			  <div class="pr-3">
			  
				<div class="field">
				  <label class="label">Short Name</label><div class="control"><input class="input" type="text" placeholder="Client Short Name" v-model="v.config.nodeinfo.l"></div>
				</div>

				<div class="field">
				  <label class="label">Description</label><div class="control"><input class="input is-success" type="text" placeholder="Client Full Name or Description" v-model="v.config.nodeinfo.d"></div>
				</div>

				<div class="field">
				  <label class="label">Notes</label><div class="control"><textarea class="textarea" placeholder="Client notes area" v-model="v.config.nodeinfo.c"></textarea></div>
				</div>

				<div class="field is-grouped">
				  <div class="control"><button class="button is-link" @click="">Save</button></div>
				  <div class="control"><button class="button is-link is-light">Cancel</button></div>
				</div>
				
			  </div>
			</div>
		</section>
		
		<footer class="modal-card-foot">
		  <button class="button is-success">Save changes</button>
		  <button class="button" onclick="toggleModal()">Cancel</button>
		</footer>
	 </div>
    </div><!--end modal pane-->	


	
  <button class="modal-close is-large" aria-label="close"></button>
 </div>
</div>

<div id="graph_layout"></div>


<script>
// script begin --------------------------------------------------------------------------------------------------------

function toggleImgFullscreen() {
  let elem = document.getElementById("imgview");

  if (!document.fullscreenElement) {
    elem.requestFullscreen().catch(err => {
      alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
    });
  } else {
    document.exitFullscreen();
  }
}


//Initialize Quill editor

var toolbarOptions = [
  ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
  ['blockquote', 'code-block'],

  [{ 'header': 1 }, { 'header': 2 }],               // custom button values
  [{ 'list': 'ordered'}, { 'list': 'bullet' }],
  [{ 'script': 'sub'}, { 'script': 'super' }],      // superscript/subscript
  [{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
  [{ 'direction': 'rtl' }],                         // text direction

  [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
  [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

  [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
  [{ 'font': [] }],
  [{ 'align': [] }],
  ['image'],
  ['video'],
  ['clean']                                         // remove formatting button
];

var quill = new Quill('#editor', {
  modules: {
    toolbar: toolbarOptions
  },
  theme: 'snow'
});
quill.disable();

function toggleQuill()
{
	let isEnabled = quill.isEnabled();
	if(isEnabled)
		_panesIndex['edit']['editor'].onAfterSubmit();
	else
		_panesIndex['view']['editor'].onBeforeShow();		
}

function populateQuill(nodeinfo)
{
	// load stuff from vPtrAttach
	// serializedDelta can be stored in persistent storage or sent in a message etc.
	let serialisedDeltas = nodeinfo[PROP_TEXTDATA] ||  "{}";
	quill.setContents(JSON.parse(serialisedDeltas));	
	let edtitle = document.getElementById('editor_title');
	edtitle.value = nodeinfo[PROP_LABEL];
}

function getQuillEdits(nodeinfo)
{
	let edtitle = document.getElementById('editor_title');
	let deltas = quill.getContents();
	nodeinfo[PROP_TEXTDATA] = JSON.stringify(deltas);
	//attNode[] = MIME_MIRUKET_NOTE;
	nodeinfo[PROP_LABEL] = edtitle.value;
	//vPtrAttach.ref.t = 'Untitled Note';
	nodeinfo[PROP_DETAIL] = 'Note';
}

function setQuillVisualState(status)
{
	let edbutton = document.getElementById('toggleEditing');
	let edtitle = document.getElementById('editor_title');

	if(status == 'enable') {
		quill.enable();
		edtitle.readOnly = false;
		edbutton.innerText = "Save";
	}
	else {
		quill.disable();
		edtitle.readOnly = true;
		edbutton.innerText = "Edit";
	}

}


// data stores ------------------------------------------------------------
const TYPE_ROOT = "__ROOT__";
const PROP_UID = "uid";
const PROP_TYPE = "ty";
const PROP_LABEL = "l";
const PROP_DETAIL = "d";
const PROP_TEXTDATA = "x";
const PROP_CUSTOM = "c";
const PROP_TIME = "t";
const PROP_LASTMOD = "m";
const PROP_BINARYDATA = "b";
const PROP_EDITING = "e";
const PROP_PARENTLIST = "in";
const PROP_CHILDLIST = "out";
const PROP_RELATIONS = "lnk";
const PROP_PARENTREFS = "inrefs";
const PROP_CHILDREFS = "outrefs";

function emptyNode(_uid = '', type = '') { 
	//return { uid: _uid, l: '', d: '', e: '', ty: type, c: '', x: '', b: '', t: '', m: '', inrefs : [], outrefs : [], in: [], out: [], lnk: [], hasChanged: false, isOpen: false}
	let node = {};
	node[PROP_UID] = _uid;
	node[PROP_TYPE] = type;
	node[PROP_LABEL] = '';
	node[PROP_DETAIL] = '';
	node[PROP_TEXTDATA] = '';
	node[PROP_CUSTOM] = '';
	node[PROP_TIME] = '';
	node[PROP_LASTMOD] = '';
	node[PROP_BINARYDATA] = '';
	node[PROP_EDITING] = '';
	node[PROP_PARENTLIST] = [];
	node[PROP_CHILDLIST] = [];
	node[PROP_PARENTREFS] = [];
	node[PROP_CHILDREFS] = [];
	node[PROP_RELATIONS] = [];
	node.hasChanged = false;
	node.isOpen = false;
	return node;
};

var _root = emptyNode('.',TYPE_ROOT);
var _index = {};
var G = { root : _root , ctxmenuData: emptyCtxMenuData()};

_index[_root.uid] = _root;
_root.l = "Root Node";


var _defaultPaneConfigs = {
	//main_pane is the target for these:
	view: {
		//key : function to return config obj
		"default" : function() {
			return {
				//indicating whether corresponding node property will be visible
				label: { visible: true, name: "Label" },
				detail: { visible: true, name: "Detail" },
				custom: { visible: true, name: "Custom Data" },
				textdata: { visible: true, name: "Text Data" },
				eventtime: { visible: true, name: "Event Time" },
				title: '',
			};
		},
	},
	edit: {
		//key : DOMelementID
		"default" : function() {
			return {
				//indicating whether corresponding node property will be visible, editable, and its label
				label: { visible: true, editable: true, name: "Label", required: true },
				detail: { visible: true, editable: true, name: "Detail", required: true },
				custom: { visible: true, editable: true, name: "Custom Data", required: false },
				textdata: { visible: true, editable: true, name: "Text Data", required: false },
				eventtime: { visible: true, editable: true, name: "Event Time", required: false },
				title: '',
			};
		},
	},
	//modal is the target for these:
	add: {
		//key : DOMelementID
		"default" : function() {
			return {
				//indicating whether corresponding node property will be visible, editable, and its label
				label: { visible: true, editable: true, name: "Label", required: true },
				detail: { visible: true, editable: true, name: "Detail", required: true },
				custom: { visible: true, editable: true, name: "Custom Data", required: false },
				textdata: { visible: true, editable: true, name: "Text Data", required: false },
				eventtime: { visible: true, editable: true, name: "Event Time", required: false },
				title: '',
			};
		},
	},
	moveparent:  {
		//key : DOMelementID
		"default" : function() { return {} },
	},
	movechildren: {
		//key : DOMelementID
		"default" : function() { return {} },
	}
};

function getDefaultConfig(type)
{
	let conf = _defaultPaneConfigs[type]['default']();
	conf.nodeinfo = emptyNode();
	return conf;
	//conf.parentNodeID = ''; the nodeinfo contains parents
}

// when adding a type to the app, have to configure it here, plus add it to ctxmenu and 
var _typeConfigs = {
	example: {
		typesAllowedForChildNodes : new Set(["placeholder"]),
		actionViewConf: { paneType: "default", config: {} },
		actionAddConf: { paneType: "default", config: {} },
		actionEditConf: { paneType: "default", config: {} },
		actionMoveParentConf: { paneType: "default", config: {} },
		actionMoveChildrenConf: { paneType: "default", config: {} },
	},
	unknown: {
		typesAllowedForChildNodes : new Set(),
		actionViewConf: { paneType: "default", config: getDefaultConfig('view') },
		actionAddConf: { paneType: "default", config: getDefaultConfig('add') },
		actionEditConf: { paneType: "default", config: getDefaultConfig('edit') },
		actionMoveParentConf: { paneType: "default", config: {} },
		actionMoveChildrenConf: { paneType: "default", config: {} },
	},
};


_typeConfigs[TYPE_ROOT] =  {
		typesAllowedForChildNodes : new Set(),
		actionViewConf: { paneType: "default", config: getDefaultConfig('view') },
		actionAddConf: { paneType: "default", config: getDefaultConfig('add') },
		actionEditConf: { paneType: "default", config: getDefaultConfig('edit') },
}

/*
_typeConfigs["foobar"] = {
		typesAllowedForChildNodes : new Set(["typeA","typeB"]),
		actionViewConf: { paneType: "default", config: {...} },
		...
	}
_typeConfigs[TYPE_ROOT].typesAllowedForChildNodes.add("foobar");

*/

// the vue objects will bind to paneConfig

var _panesIndex = {
	//main_pane divs:
	view: {
		//pane key 
		"default" : {
			divID: "view_default", //DOMelementID
			v: { config: getDefaultConfig('view')},
			onBeforeShow: function(){}, //get config using this.v.config  (will have nodeinfo and parentID)
		},
		//todo: file, image, text, note, annotation(nothing), folder(?)
		"download" : {
			divID: "view_download", //DOMelementID
			v: { config:  getDefaultConfig('view')},
			onBeforeShow: function(){}, //get config using this.v.config  (will have nodeinfo and parentID)
		},
		"textbody" : {
			divID: "view_textbody", //DOMelementID
			v: { config:  getDefaultConfig('view')},
			onBeforeShow: function(){}, //get config using this.v.config  (will have nodeinfo and parentID)
		},
		"editor" : {
			divID: "view_editor", //DOMelementID
			v: { config:  getDefaultConfig('view')},
			onBeforeShow: function(){
				//need to fetch attachment body and populate quill
				updateAttachmentNodeIfChangedOrEmpty(this.v.config.nodeinfo);
				populateQuill(this.v.config.nodeinfo);
				setQuillVisualState("disable");
			}, //get config using this.v.config  (will have nodeinfo and parentID)
		},

	},
	// for edit panetypes:
	// onBeforeCopyNode() paneConfig.nodeinfo contains the original node, to allow actions on it to occur
	// onBeforeShow()  paneConfig.nodeinfo contains a copy of the node, run before pane is shown
	// onAfterSubmit() paneConfig.nodeinfo contains a copy of the node, run after submitAction button is clicked (put upsert request in here)
	edit: {
		"default" : {
			divID: "edit_default",
			v: { config:  getDefaultConfig('edit')},
			onBeforeShow: function(){},
			onAfterSubmit: function(){ upsertGeneric(this.v.config.nodeinfo); },
			},
		"editor" : {
			divID: "view_editor",
			v: { config:  getDefaultConfig('edit')},
			onBeforeCopyNode: function(){
				//need to fetch attachment body if its not there or needs an update
				updateAttachmentNodeIfChangedOrEmpty(this.v.config.nodeinfo);
			}, //get config using this.v.config  (will have nodeinfo and parentID)
			onBeforeShow: function(){
				populateQuill(this.v.config.nodeinfo);
				setQuillVisualState("enable");
			},
			onAfterSubmit: function(){
				let nodeInf = this.v.config.nodeinfo;
				getQuillEdits(nodeInf);
				if(nodeInf[PROP_TEXTDATA] != _index[nodeInf[PROP_UID]][PROP_TEXTDATA])
					upsertGeneric(nodeInf);
				setQuillVisualState("disable");
			},
		},
	},
	//modal divs:
	add: {
		"default" : {
			divID: "add_default",
			v: { config:  getDefaultConfig('add')},
			onBeforeShow: function(){},
			onAfterSubmit: function(){ upsertGeneric(this.v.config.nodeinfo); },
			},
		//todo: file, image, text, note, annotation, folder
		"fileupload" : {
			divID: "add_fileupload",
			v: { config:  getDefaultConfig('add')},
			onBeforeShow: function(){},
			onAfterSubmit: function(){},
			},
		"editor" : {
			divID: "add_default",
			v: { config:  getDefaultConfig('add')},
			onBeforeShow: function(){},
			onAfterSubmit: function(){ upsertGeneric(this.v.config.nodeinfo); },
			},

	},
	moveparent:  {
		"default" : {},
	},
	movechildren: {
		"default" : {},
	}
};




// show/hide the main panes -------------------------------------------------

const D_HIDE = "none";
const D_SHOW = "block";

function switchPaneIfMatches(panes, name)
{
	for (const [key, value] of Object.entries(panes)) {
		console.log(`${key}: ${value}`);
		let div = document.getElementById(value.divID);
		div.style.display = (key == name) ? D_SHOW : D_HIDE;
	}
}

function switchPane(paneType, paneName)
{
	//mainPanes.forEach((item,index) => {item.style.display = (index == paneNum) ? D_SHOW : D_NONE});

	//main_pane divs
	if(paneType == 'view' || paneType == 'edit')
	{
		switchPaneIfMatches(_panesIndex.view, (paneType == 'view' ? paneName : ''));
		switchPaneIfMatches(_panesIndex.edit, (paneType == 'edit' ? paneName : ''));
	}
	else
	//modal divs
	{
		switchPaneIfMatches(_panesIndex.add, (paneType == 'add' ? paneName : ''));
		switchPaneIfMatches(_panesIndex.moveparent, (paneType == 'moveparent' ? paneName : ''));
		switchPaneIfMatches(_panesIndex.movechildren, (paneType == 'movechildren' ? paneName : ''));
		// show the modal div
		document.getElementById("modal_div").classList.toggle('is-active');
	}
}

// event handlers ------------------------------------------------------------

function HideContextMenu(){
	document.getElementById("ctxmenu-div").style.display = "none";
}

function showLoading(waiting)
{
  let elem = document.getElementById("body_container");
  elem.style.cursor = (waiting) ? "wait" : "auto";
  let logo = document.getElementById("id_logo");
  if(waiting)
	logo.classList.replace('ico-logo', 'ico-load');
  else
	logo.classList.replace('ico-load', 'ico-logo');
}

const fileInput = document.getElementById("at_file");
  fileInput.onchange = () => {
    if (fileInput.files.length > 0) {
      const fileName = document.getElementById('at_file_name');
      fileName.textContent = fileInput.files[0].name;
    }
  };

function serialise(jsonObj) {
    return JSON.stringify(jsonObj, (key,value) =>
	{
		if (key==PROP_PARENTREFS || key==PROP_CHILDREFS || key==PROP_LASTMOD) return undefined;
		//should nullify certain values that are '' eg. t, x, e, c
		if ((key==PROP_TEXTDATA || key==PROP_BINARYDATA || key==PROP_TIME || key==PROP_EDITING || key==PROP_TYPE) && value == '') return undefined;
		else return value;
	} );
}

function clearList(list)
{
	while(list.length > 0)
		list.pop()
}

function clearObjectProperties(obj)
{
	for (var prop in obj) {
		if (obj.hasOwnProperty(prop)) {
			delete obj[prop];
		}
	}
}

const ip_rgx = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/

function convertIPtoNum(ipstr) {
  let octs = ipstr.split('.');
  return (octs[0] * 16777216.0) + (octs[1] * 65536.0) + (octs[2] * 256.0) + octs[3] * 1.0;
}


//genericUpsert
async function upsertGeneric(node)
{	
	showLoading(true);
	console.log("upsert: ",serialise(node));
	await fetch('upsert',{
		method: 'POST',
		headers: {
		  'Content-Type': 'application/json'
		},
		body: '['+serialise(node)+']' // body data type must match "Content-Type" header
	})
	.then(response => response.json())
	.then(rdata => { 
		console.log(JSON.stringify(rdata));
		if(rdata && rdata.length > 0)
		{
			_index[rdata[0]] = emptyNode(rdata[0]);
			//refreshQuery()
		}
		else
		{
			console.log("an error occurred when attempting to upsert node");//deal with the error
		}
	});
	showLoading(false);

	await refreshNodes();
}


//fileupload
async function fileupload(node)
{
	const input = document.getElementById('at_file');

	let params = {};
	if(node[PROP_UID])
		params.attachid = node[PROP_UID];
	params.parentid = node[PROP_PARENTLIST][0].uid;
	
	let data = new FormData();
	data.append('filedata', input.files[0]);
	data.append('type', 'file_upload');
	data.append('_p', JSON.stringify(params));

	await fetch('upload', {
	  method: 'POST',
	  //mode: 'no-cors', //for testing with httpbin
	  //!!important: don't set the content-type
	  body: data
	  }).then(response => {
			console.log(response);
			if(response.startsWith('0x'))
			{
				_index[response] = emptyNode(response);
			}
		});//.then(rdata => { console.log(JSON.stringify(rdata)); }
	//);
	
	await refreshNodes();
}
//updatenodes (send list of uids to server and get nodes (newer than last update)
// create inrefs, outrefs, isOpen
var _lastProjTreeUpdateTime = 0;

function getUidsFromIndex()
{
	let listOfUids = [];
	for (const [key, value] of Object.entries(_index)) {
		listOfUids.push(key);
	}
	return listOfUids;
}

async function fetchChildNodes(nodeid)
{
/*
	let newUids = [];
	let n = _index[nodeid];
	if(n && n[PROP_CHILDLIST])
	{
		n[PROP_CHILDLIST].forEach(uidobj => {
			if(!_index[uidobj.uid]) {
				//_index[uidobj.uid] = emptyNode(uidobj.uid);
				newUids.push(uidobj.uid);
			}
		});
		await fetchNodes(newUids,PROP_LASTMOD,'gt',0,0);//refreshNodes();
	}
	*/
	await fetchNodes([nodeid],PROP_LASTMOD,'gt',0,1);
}

async function refreshNodes()
{
	await fetchNodes(getUidsFromIndex());
}

async function fetchInitialNodes()
{
	_lastProjTreeUpdateTime = 0;
	//this will fetch only the root node:
	await fetchNodes(null,PROP_LASTMOD,'gt',0,0);
	//there should be only two nodes in the index after this initial request:
	// _index['.'] (the placeholder for root node)
	// _index['0xN'] (the actual root node
	for (const [key, value] of Object.entries(_index)) {
		if(key != '.') {
			//G.root = value;
			updateNode(G.root,value);
			createEdgesForNode(G.root);
			delete _index['.'];
			_index[G.root[PROP_UID]] = G.root;
		}
	}
	await fetchChildNodes([G.root.uid]);
}

async function fetchNodes(_uids, _field = PROP_LASTMOD, _op = 'gt', _val = _lastProjTreeUpdateTime, _depth = 0)
{
//  /nodes POST
//  { field=m op='gt' val=_lastProjTreeUpdateTime depth=0
//   uids = [] }
	let data = { field: _field, op: _op, val: `${_val}`, depth: _depth, uids: _uids };
	showLoading(true);
console.log('A'+JSON.stringify(data));
	await fetch('/nodes', {
		method: 'POST',
		//mode: 'no-cors', //for testing with httpbin
		headers: {
		  'Content-Type': 'application/json'
		},
		body: JSON.stringify(data)
	}).then(response => response.json() )
	.then(rdata => { 
		console.log(JSON.stringify(rdata));
		if(rdata && rdata.nodes && !rdata.error)
		{
			updateNodeTree(rdata);
		}
		else
		{
			console.log("update nodes failed: ",rdata.message);//deal with the error
		}
	});//.catch(console.log("update nodes failed: caught exception."));
	showLoading(false);	
}

function createEdgesFromUids(listUidObjs)
{
	let tmpList = [];
	if(listUidObjs)
		listUidObjs.forEach(uidobj => {
			if(_index[uidobj.uid]) 
				tmpList.push(_index[uidobj.uid]);
		});
	return tmpList;
}

function createEdgesForNode(node)
{
	node[PROP_PARENTREFS] = createEdgesFromUids(node[PROP_PARENTLIST]);
	node[PROP_CHILDREFS] = createEdgesFromUids(node[PROP_CHILDLIST]);
}

function updateNode(existingNode, updatedNode)
{
	for (const [key, value] of Object.entries(updatedNode)) {
	  existingNode[key] = value;
	  //console.log("update:",key,value);
	}

	existingNode.hasChanged = (updatedNode[PROP_LASTMOD] != existingNode[PROP_LASTMOD]); 
}

function updateNodeTree(serverResponse)
{
	// delete nodes
	// delete edges
	// upsert nodes

	let nodes = serverResponse.nodes;
	for (let i = 0; i < nodes.length; i++)
	{
		//  if exists in mainindex then update
		let node = nodes[i];
		let tnode = _index[node.uid];
		if(tnode)
			updateNode(tnode, node);
		else
		{
			node.hasChanged = true;
			_index[node.uid] = node;
			tnode = node;
			//console.log("add main:",tnode.uid);
		}
	}

	for (let i = 0; i < nodes.length; i++)	
		createEdgesForNode(_index[nodes[i].uid]);

	_lastProjTreeUpdateTime = serverResponse.timestamp;
	//vue_col_groups.$forceUpdate();
	//vue_col_details.$forceUpdate();
}

async function updateAttachmentNodeIfChangedOrEmpty(node,datafield = PROP_TEXTDATA)
{
	if(node.hasChanged || !node[datafield])
	{
console.log("att refresh: ",node.m);
		showLoading(true);
		await fetch('/attachment/'+node[PROP_UID]+'/'+(!node[datafield] ? '0' : _lastProjTreeUpdateTime))
			.then(response => response.json())
			.then(data => { 
				//vPtrAttach.ref.b = data.nodes[0].b;
				updateNodeTree(data);
				//vPtrAttach.ref = _index[aID];
				//vPtrAttach.parentID = _index[aID].in[0].uid;
				}
			);
		showLoading(false);
		//node.hasChanged = false;
		//vPtrAttach.ref = _index[aID];
		//vue_mp_showfile.$forceUpdate();
	}
}


/////////////////////////////////////////////////////////////////////////////////////////
//     VueJS Bindings
/////////////////////////////////////////////////////////////////////////////////////////

// define the tree-item component
Vue.component("tree-item", {
	template: "#item-template",
	props: {
	  item: Object    //these properties can be accessed/modified externally, as well as in computed/methods (refer to it using this.item)
	},
	data: function() {  //component instance's initial state is obtained from here, refer to data in methods/computed using this.isOpen
	  return {
		isOpen: true
	  };
	},
	computed: {
	  hasChildren: function() {
		return this.item.out && this.item.out.length;
	  },
	  name: function() {
		console.log("name this.item",this.item);
		return this.item[PROP_LABEL];
	  }
	},
	methods: {
		showCtxMenu: function (event,nodeID) {
			console.log(event,nodeID);
			  contextMenuFor("ctxmenu-div",event,nodeID);
			  //pass the uid to it somehow
		},
		viewNode: function(e, id) {
		//view node
		console.log(e,id);
		},
		toggle: function(id) {
		if (this.hasChildren) {
		  if(!this.isOpen) 
			fetchChildNodes(id);
		  this.isOpen = !this.isOpen;
		}
		},
		makeFolder: function() {
		/*if (!this.hasChildren) {
		  this.$emit("make-folder", this.item);
		  this.isOpen = true;
		}*/
		},
	}
});


// boot up the demo
var v_tree_pane = new Vue({
	el: "#v_tree_pane",
	data: {
	  treeData: G
	},
	methods: {
		makeFolder: function(item) {
			Vue.set(item, "children", []);
			this.addItem(item);
		},
		addItem: function(item) {
			item.children.push({
			  name: "new stuff",
			  children: [] //**added this and now mchild will work for all chidren
		});
	  }
	}
});

function contextMenuFor(ctxmenudiv,event,nodeID)
{
	event.preventDefault();

	let n = _index[nodeID];

	if(n) {
		G.ctxmenuData = emptyCtxMenuData(n[PROP_UID]);

		let nConfig = _typeConfigs[n[PROP_TYPE]] || _typeConfigs['unknown'];

		if(nConfig.actionEditConf)
			G.ctxmenuData.mainOptions.push("edit");
		if(nConfig.actionMoveParentConf)
			G.ctxmenuData.mainOptions.push("moveparent");
		if(nConfig.actionMoveParentConf)
			G.ctxmenuData.mainOptions.push("movechildren");
		
		let allowedToAdd = Array.from(nConfig.typesAllowedForChildNodes || []);
		allowedToAdd.forEach((typename,index) => {G.ctxmenuData.addOptions.push(`+${typename}`)});

		let menu = document.getElementById(ctxmenudiv);
		menu.style.left = event.pageX + 'px';
		menu.style.top = event.pageY + 'px';
		menu.style.display = 'block';

	}
	//nodeID not found, no context menu to show
	return;
}


// {uid:'0x345',mainOptions:['edit','move'],addOptions:['+foo','+bar']}
function emptyCtxMenuData(_uid = '.') {
	return {uid: _uid, mainOptions: [], addOptions: []};
}

//var G.ctxmenuData = emptyCtxMenuData();

var v_action_funcs = { 
	view: function (typename, uid) { 
		let tc = _typeConfigs[typename];
		if(tc) {
			let conf =  tc.actionViewConf || _typeConfigs.unknown.actionViewConf;
			_panesIndex.view[conf.paneType].v.config = conf.config;
			_panesIndex.view[conf.paneType].v.config.nodeinfo = _index[uid];
			_panesIndex.view[conf.paneType].onBeforeShow();
			switchPane('view',conf.paneType);
		}
	},
	add: function (typename, _uid) { 
		let tc = _typeConfigs[typename];
		if(tc) {
			let conf =  tc.actionAddConf || _typeConfigs.unknown.actionAddConf;
			_panesIndex.add[conf.paneType].v.config = conf.config;
			let newN = emptyNode('',typename);
			newN[PROP_PARENTLIST].push({uid: _uid});
			_panesIndex.add[conf.paneType].v.config.nodeinfo = newN;
			_panesIndex.add[conf.paneType].onBeforeShow();
			switchPane('add',conf.paneType);
		}
	},
	edit: function (uid) { 
		let n = _index[uid];
		let tc = _typeConfigs[(n[PROP_TYPE] || "unknown")];
		if(tc) {
			let conf =  tc.actionEditConf || _typeConfigs.unknown.actionEditConf;
			_panesIndex.edit[conf.paneType].v.config = conf.config;
			
			if(_panesIndex.edit[conf.paneType].onBeforeCopyNode) {
				_panesIndex.edit[conf.paneType].v.config.nodeinfo = n;
				_panesIndex.edit[conf.paneType].onBeforeCopyNode();
			}			
			let tmpNodeCopy = emptyNode(n[PROP_UID]);
			tmpNodeCopy[PROP_LABEL] = n[PROP_LABEL] || null;
			tmpNodeCopy[PROP_DETAIL] = n[PROP_DETAIL] || null;
			tmpNodeCopy[PROP_CUSTOM] = n[PROP_CUSTOM] || null;
			tmpNodeCopy[PROP_TEXTDATA] = n[PROP_TEXTDATA] || null;
			tmpNodeCopy[PROP_TIME] = n[PROP_TIME] || null;
			tmpNodeCopy.hasChanged = n.hasChanged;
			_panesIndex.edit[conf.paneType].v.config.nodeinfo = tmpNodeCopy;
			
			_panesIndex.edit[conf.paneType].onBeforeShow();
			switchPane('edit',conf.paneType);
		}
	},
};

var v_ctxmenu = new Vue({
	el: "#v_ctxmenu",
	data: {
	  vdata: G
	},
	methods: {
		ctxmenuAction: function (e, ac, uid) {
			console.log ( "ctxmenuAction: ",ac, uid);
			if(ac.startsWith('+')) {
				v_action_funcs['add'](ac.substring(1),uid);
			}
			else
				v_action_funcs[ac](uid);
		}
	}
});


function handleSubmit(ac, pane) {
	console.log ( "handleSubmit: ",ac, pane);
	_panesIndex[ac][pane].onAfterSubmit();
}



var v_view_default = new Vue({
	el: '#v_view_default',
	data: { 
	   v: _panesIndex['view']['default'].v
	},
	methods : {
        testEventHandler: function (e,id) {
			console.log(e,id);
        }, 
		vCustom :  function(x){ 
			console.log(x);
		}
	}
});

var v_view_download = new Vue({
	el: '#v_view_download',
	data: { 
	   v: _panesIndex['view']['download'].v
	},
	methods : {
        testEventHandler: function (e,id) {
			console.log(e,id);
        }, 
		vCustom :  function(x){ 
			console.log(x);
		}
	}
});

var v_view_textbody = new Vue({
	el: '#v_view_textbody',
	data: { 
	   v: _panesIndex['view']['textbody'].v
	},
	methods : {
        testEventHandler: function (e,id) {
			console.log(e,id);
        }, 
		vCustom :  function(x){ 
			console.log(x);
		}
	}
});

var v_edit_default = new Vue({
	el: '#v_edit_default',
	data: { 
	   v: _panesIndex['edit']['default'].v
	},
	methods : {
        testEventHandler: function (e,id) {
			console.log(e,id);
        }, 
		vCustom :  function(x){ 
			console.log(x);
		}
	}
});

var v_add_default = new Vue({
	el: '#v_add_default',
	data: { 
	   v: _panesIndex['add']['default'].v
	},
	methods : {
        testEventHandler: function (e,id) {
			console.log(e,id);
        }, 
		vCustom :  function(x){ 
			console.log(x);
		}
	}
});

var v_add_fileupload = new Vue({
	el: '#v_add_fileupload',
	data: { 
	   v: _panesIndex['add']['fileupload'].v
	},
	methods : {
        testEventHandler: function (e,id) {
			console.log(e,id);
        }, 
		vCustom :  function(x){ 
			console.log(x);
		}
	}
});




//column_details
/*
var vue_col_details = new Vue({
	el: '#v_column_details',
	data: { 
	   sg: vPtrSubGroup
	},
	methods : {
        showCtxMenuItem: function (e,id) {
              contextMenuFor("ctxmenu-item-div",e);
			  ctxmenu_item_selected_uid = id;
        }, 
        showCtxMenuAtt: function (e,id) {
              contextMenuFor("ctxmenu-att-div",e);
			  ctxmenu_att_selected_uid = id;
        }, 
		vSelectAttachment : function(a) {
			showAttachment(a);
		}
	}
});
*/

var v_currently_selected_node = { node: G.root };

var vue_topnav = new Vue({
	el: '#v_topnav',
	data: { 
	   v: v_currently_selected_node,
	},
	methods: {
		vShowTasks: function() {
			//showTasks();
		}
	}
});




const TYPE_CLIENT = "Cl";
const TYPE_PROJECT = "Pr";
const TYPE_GROUP = "Gr";
const TYPE_SUBGROUP = "Sg";
const TYPE_ITEM = "It";
const TYPE_ATTACHMENT = "At";

const MIME_MIRUKET_NOTE = "x-miruket-editable";

//startup, fetch clients
//showClients();
fetchInitialNodes();

</script>

</div></body></html>
